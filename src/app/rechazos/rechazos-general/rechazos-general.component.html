<div class="screen">
  <div class="d-flex flex-column gap-2 flex-xl-row justify-content-between align-items-center py-3 m-3">
    <div class="d-flex align-items-center justify-content-start ">
      <mat-icon class="color-dark">broken_image</mat-icon>
      <h1 class="mb-0 ps-2 color-dark page-heading">Converter</h1>
    </div>
    <!-- Info Rechazos -->
    <div class="mx-3 details d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
      <div class="bg-white text-center rounded-3 d-flex justify-content-evenly align-items-center gap-2 px-3">
        <div class="d-flex flex-column m-1">
          <h3 class="m-0 fw-bold">50</h3>
          <span class="text-muted custom-bold ">Pendiente</span>
        </div>
        <div class="border my-2" style="height: 45px;"></div>
        <div class="d-flex flex-column m-1">
          <h3 class="m-0 fw-bold">135</h3>
          <span class="text-muted custom-bold ">Rechazado</span>
        </div>
        <div class="border my-2" style="height: 45px;"></div>
        <div class="d-flex flex-column m-1">
          <h3 class="m-0 fw-bold">200</h3>
          <span class="text-muted custom-bold">En proceso</span>
        </div>
        <div class="border my-2" style="height: 45px;"></div>
        <div class="d-flex flex-column m-1">
          <h3 class="m-0 fw-bold">35</h3>
          <span class="text-muted custom-bold">No Aplica</span>
        </div>
        <div class="border my-2" style="height: 45px;"></div>
        <div class="d-flex flex-column m-1">
          <h3 class="m-0 fw-bold">269</h3>
          <span class="text-muted custom-bold">Vendido</span>
        </div>
      </div>
    </div>
    <!-- END Info Rechazos -->
    <div class="d-flex align-items-center gap-2">
      <div class="btn-group" role="group">
        <button type="button" class="btn btn-primary" (click)="exportar_rechazos()">Exportar</button>
        <button type="button" class="btn btn-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
          {{ selectedOption }} <i class="bi bi-caret-down"></i>
        </button>
        <ul class="dropdown-menu">
          <li><button class="dropdown-item" (click)="updateOption('Excel')">Excel</button></li>
          <li><button class="dropdown-item" (click)="updateOption('CSV')">CSV</button></li>
          <li><button class="dropdown-item" (click)="updateOption('Json')">Json</button></li>
        </ul>
      </div>
      <button class="btn btn-color d-flex justify-content-center align-items-center" (click)="verEnMapa()">
        <i class="bi bi-geo-alt-fill"></i>
      </button>
      <button class="btn btn-secondary d-flex align-items-center" data-bs-toggle="modal" data-bs-target="">
        <i class="bi bi-funnel-fill"></i>
      </button>
    </div>
    
  </div>
  <!-- TABLA -->
  <div class="table-responsive m-3">
    <table class="table table-hover table-sm my-0">
      <thead>
        <tr class="">
          <!-- Checkbox Column -->
          <th scope="col" class="text-center">
            <input type="checkbox" (change)="masterToggle()"
                   [checked]="selection.hasValue() && isAllSelected()"
                   [indeterminate]="selection.hasValue() && !isAllSelected()" />
          </th>
          <!-- Estado Column -->
          <th scope="col" class="text-center">Estado</th>
          <!-- Población Column -->
          <th scope="col">Población</th>
          <!-- Cliente Column -->
          <th scope="col">Cliente</th>
          <!-- Subfamilia Column -->
          <th scope="col">Subfamilia</th>
          <!-- Producto Column -->
          <th scope="col">Producto</th>
          <!-- Rechazo Column -->
          <th scope="col">Rechazo</th>
          <!-- Precio Column -->
          <th scope="col" class="text-end">Precio</th>
          <!-- Promo Propia Column -->
          <th scope="col" class="text-center"></th>
          <!-- Competidor Column -->
          <th scope="col" class="text-end">Comp.</th>
          <!-- Promo Competidor Column -->
          <th scope="col" class="text-center"></th>
          <!-- Competidor Column -->
          <th scope="col">Competidor</th>
          <!-- Acción Correctora Column -->
          <th scope="col" class="text-center">Acción Correctora</th>
          <!-- Propuesta Agente Column -->
          <th scope="col">Propuesta Agente</th>
          <!-- Fecha Interés Column -->
          <th scope="col" class="text-success text-end">Fecha Interés</th>
          <!-- Expand Column -->
          <th scope="col" class="text-center"></th>
        </tr>
      </thead>
      <tbody>
        <ng-container *ngFor="let row of dataSource.data">
          <tr>
            <!-- Checkbox Column -->
            <td class="text-center centrado_column">
              <input type="checkbox" (click)="$event.stopPropagation()" 
                     (change)="selection.toggle(row)" 
                     [checked]="selection.isSelected(row)" />
            </td>
            <!-- Estado Column -->
            <td class="text-center ">
              <div class="d-flex align-items-center justify-content-center">
                <img [src]="getOptionImage(row.estado)" alt="{{ row.estado }} Image" class="option-image">
                <select class="form-select form-select-sm select_estado" [(ngModel)]="row.estado" (change)="actualizarEstados(row)">
                  <option *ngFor="let estado of estados" [value]="estado.estado">
                    {{ estado.estado }}
                  </option>
                </select>
              </div>
            </td>
            <!-- Población Column -->
            <td class="centrado_column">{{ row.poblacion }}</td>
            <!-- Cliente Column -->
            <td class="row_cliente centrado_column">{{ row.cliente }}</td>
            <!-- Subfamilia Column -->
            <td class="centrado_column">{{ row.nombre_subfamilia }}</td>
            <!-- Producto Column -->
            <td class="row_producto centrado_column">{{ row.producto }}</td>
            <!-- Rechazo Column -->
            <td class="text-center">
              <select class="form-select form-select-sm text-danger select_rechazo" [(ngModel)]="row.tipo_rechazo">
                <option *ngFor="let rechazo of tipos_rechazo" [value]="rechazo.tipo">{{ rechazo.tipo }}</option>
              </select>
            </td>
            <!-- Precio Column -->
            <td class="text-end row_precio_producto centrado_column">{{ row.precio_producto }} €</td>
            <!-- Promo Propia Column -->
            <td class="text-center centrado_column">
              <i *ngIf="row.tiene_promo_propia" class="promo-icon" [attr.title]="row.promo_propia">P</i>
            </td>
            <!-- Competidor Column -->
            <td class="text-end row_precio_competidor centrado_column">{{ row.precio_competidor }} €</td>
            <!-- Promo Competidor Column -->
            <td class="text-center centrado_column">
              <i *ngIf="row.tiene_promo_competencia" class="promo-icon" [attr.title]="row.promo_competencia">P</i>
            </td>
            <!-- Competidor Column -->
            <td>
              <select class="form-select form-select-sm row_select_competidor" [(ngModel)]="row.competidor">
                <option *ngFor="let competidor of competidores" [value]="competidor.id">{{ competidor.nombre }}</option>
              </select>
            </td>
            <!-- Acción Correctora Column -->
            <td class="">
              <div class="d-flex align-items-center gap-2">
                <!-- Campo para precio de promoción -->
                <input type="number" class="form-control form-control-sm accion_correctora_precio text-success" [(ngModel)]="row.pvp_es_promocion_precio" placeholder="0" />
    
                <!-- Campo para símbolo de promoción -->
                <select class="form-select form-select-sm accion_correctora_simbolo" [(ngModel)]="row.id_simbolo" (change)="updateSymbol(row)">
                  <option *ngFor="let simbolo of simbolos" [value]="simbolo.id">
                    {{ simbolo.simbolo }}
                  </option>
                </select>
    
                <!-- Campo para acción correctora -->
                <input type="text" class="form-control form-control-sm row_accion_correctora text-success" [(ngModel)]="row.accion_correctora" maxlength="50" placeholder="Acción Correctora" />
              </div>
            </td>
            <!-- Propuesta Agente Column -->
            <td class="row_propuesta_agente centrado_column">{{ row.propuesta_agente }}</td>
            <!-- Fecha Interés Column -->
            <td class="text-success centrado_column row_fecha_interes">{{ row.fecha_interes }}</td>
            <!-- Expand Column -->
            <td class="text-center">
              <button class="btn btn-link p-0" (click)="expandedElement = (expandedElement === row ? null : row)">
                <i class="bi" [ngClass]="expandedElement === row ? 'bi-chevron-up' : 'bi-chevron-down'"></i>
              </button>
            </td>
          </tr>
  
          <!-- Row Expanded Detail -->
          <ng-container *ngIf="expandedElement === row">
            <tr>
              <td [attr.colspan]="displayedColumns.length">
                <div class="p-2">
                  <div class="row mb-2">
                    <div class="col-md-3 col-sm-6">
                      <strong>PVP:</strong> {{ row.precio_producto }} €
                    </div>
                    <div class="col-md-3 col-sm-6">
                      <strong>Promoción Propia:</strong> {{ row.promo_propia }}
                    </div>
                    <div class="col-md-3 col-sm-6">
                      <strong>Precio Competidor:</strong> {{ row.precio_competidor }} €
                    </div>
                    <div class="col-md-3 col-sm-6">
                      <strong>Promoción Competidor:</strong> {{ row.promo_competencia }}
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-12">
                      <strong>Notas:</strong> {{ row.notas }}
                    </div>
                  </div>
                </div>
              </td>
            </tr>
          </ng-container>
        </ng-container>
      </tbody>
    </table>
  </div>
  <!-- Paginador -->
   
  <nav>
    <ul class="pagination justify-content-center">
      <li class="page-item" [class.disabled]="!paginator?.hasPreviousPage()" (click)="paginator?.previousPage()">
        <a class="page-link" href="javascript:void(0)">Anterior</a>
      </li>
      <li class="page-item disabled">
        <span class="page-link" *ngIf="paginator">
          {{ paginator.pageIndex + 1 }} / {{ paginator.getNumberOfPages() }}
        </span>
      </li>
      <li class="page-item" [class.disabled]="!paginator?.hasNextPage()" (click)="paginator?.nextPage()">
        <a class="page-link" href="javascript:void(0)">Siguiente</a>
      </li>
    </ul>
  </nav>
  
  <!-- END TABLA -->
  <!-- menu derecho -->
    <!-- Filtros (Menú derecho) -->
    <div class="modal fade" tabindex="-1" id="drawer" aria-labelledby="expandedElement" aria-hidden="true">
      <div class="offcanvas-header">
        <h5 id="drawerLabel">Filtro de Rechazos</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
      </div>
      <form [formGroup]="form" (ngSubmit)="applyFilter()" class="d-flex flex-column gap-3 p-3">
        <div class="d-flex flex-column gap-3">
          <button class="btn btn-primary" type="submit">Filtrar</button>
          <button type="button" class="btn btn-secondary" (click)="filtroReset()">Limpiar</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="offcanvas">Cancelar</button>
          <div class="mb-2 d-flex flex-column gap-3">
            <div class="form-group">
              <label for="estado">Estado</label>
              <select id="estado" class="form-select" formControlName="EstadoFilterControl">
                <option value="">- Todos -</option>
                <option value="Rechazado">Rechazado</option>
                <option value="En Proceso">En Proceso</option>
                <option value="Vendido">Vendido</option>
                <option value="No aplica">No aplica</option>
              </select>
            </div>
            <div class="form-group">
              <label for="poblacion">Población</label>
              <input id="poblacion" class="form-control" formControlName="PoblacionFilterControl" />
            </div>
            <div class="form-group">
              <label for="provincia">Provincia</label>
              <input id="provincia" class="form-control" formControlName="ProvinciaFilterControl" />
            </div>
            <div class="form-group">
              <label for="producto">Producto</label>
              <input id="producto" class="form-control" formControlName="ProductoFilterControl" />
            </div>
            <div class="form-group">
              <label for="familia">Familia</label>
              <input id="familia" class="form-control" formControlName="FamiliaFilterControl" />
            </div>
            <div class="form-group">
              <label for="subfamilia">Subfamilia</label>
              <input id="subfamilia" class="form-control" formControlName="SubFamiliaFilterControl" />
            </div>
          </div>
        </div>
      </form>
    </div>
</div>