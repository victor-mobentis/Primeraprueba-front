<div class="background-light-gray d-flex flex-column">
  <div class="d-flex flex-column gap-2 justify-content-between align-items-center p-2 titulo bg-white ">
    <!-- titulo y icono -->
    <mobentis-page-title [icon]="'columns-gap'" [isBootstrapIcon]="true" [title]="'Rechazos'"></mobentis-page-title>
    <!-- Info Rechazos -->
    <div class="max-w-kpi">
      <mobentis-kpi [selectedFilters]="selectedFilters" [searchTerm]="searchTerm"></mobentis-kpi>
    </div>
    <!-- END Info Rechazos -->
  </div>
  <!-- parte de filtros y botones -->
  <div class="mt-3 mx-2">
    <div class="d-flex flex-column flex-lg-row align-items-center justify-content-between gap-2">
      <div class="d-flex flex-column flex-lg-row gap-3 align-items-center">
        <!-- buscado -->
        <div class="input-group">
          <mobentis-search-input [searchTerm]="searchTerm" (searchChange)="onSearch($event)"
            (errorDeCaracteres)="mostrarError = $event"></mobentis-search-input>
        </div>

        <!-- Selector de Empresas (Dropdown) -->
          <mobentis-empresa-dropdown 
            *ngIf="isEmpresaDropdownVisible"
            (empresasChange)="onEmpresasChange($event)">
          </mobentis-empresa-dropdown>            
        <!-- boton de filtros aplicados o limpiar -->
        <mobentis-filter-container [componentId]="'rechazos-general'" [selectedFilters]="selectedFilters"
          (filtersChanged)="onFiltersChanged($event)">
        </mobentis-filter-container>
      </div>
      <!-- boton de exportar y mapa -->
      <div class="d-flex align-items-center gap-2">
        <div *ngIf="cargando_filtros" class="d-flex justify-content-center">
          <div class="spinner-border" role="status">
            <span class="sr-only">Loading...</span>
          </div>
        </div>
        <!-- Mensaje para actualizar -->
        <mobentis-message-update [isVisible]="hasUnsavedChanges" (saveChanges)="guardarCambios()"></mobentis-message-update>
        <!-- boton de exportar -->
        <mobentis-btn-export (formatSelected)="exportData($event)"></mobentis-btn-export>
        <button class="btn btn-primary d-flex justify-content-center align-items-center" (click)="verEnMapa()">
          <i class="bi bi-geo-alt-fill"></i>
        </button>
      </div>
    </div>
    <!-- Mensaje de error fuera del componente search-input -->
    <div *ngIf="mostrarError" class="text-danger mt-1">
      Caracteres no permitidos
    </div>
    <!-- TABLA -->
    <div class="table-responsive mt-3 {{cargando?'d-none':''}}">
      <table class="table table-sm table-hover" #tablaRechazos>
        <thead>
          <tr class="">
            <!-- Checkbox Column -->
            <th scope="col" class="text-center p-2 row_checkboxy">
              <div class=" d-flex align-items-center justify-self-center">
                <input type="checkbox" (change)="masterToggle()" [checked]="selection.hasValue() && isAllSelected()"
                  [indeterminate]="selection.hasValue() && !isAllSelected()">
              </div>
            </th>
            <!-- Acción Correctora Column -->
            <th scope="col" class="text-center row_accion_correctora header-correctora background-color-primary">
              Convertir en oportunidad (% ó €
              + Promo)</th>
            <!-- Estado Column -->
            <th scope="col" class="text-center cursor select_estado color-primary " (click)="sortData('status')">
              Estado
              <i *ngIf="sortColumn === 'status'" class="bi"
                [ngClass]="sortDirection === 'asc' ? 'bi-arrow-up' : 'bi-arrow-down'"></i>
            </th>
            <!-- Primer Rechazo Fecha Column -->
            <th scope="col" class="cursor row_fecha color-primary" (click)="sortData('r.last_rejection_date')">
              Fecha
              <i *ngIf="sortColumn === 'r.last_rejection_date'" class="bi"
                [ngClass]="sortDirection === 'asc' ? 'bi-arrow-up' : 'bi-arrow-down'"></i>
            </th>
            <!-- Población Column -->
            <th scope="col" class="row_poblacion cursor color-primary" (click)="sortData('city')">
              Población
              <i *ngIf="sortColumn === 'city'" class="bi"
                [ngClass]="sortDirection === 'asc' ? 'bi-arrow-up' : 'bi-arrow-down'"></i>
            </th>
            <!-- Cliente Column -->
            <th scope="col" (click)="sortData('customer_name')" class="cursor color-primary">
              Cliente
              <i *ngIf="sortColumn === 'customer_name'" class="bi"
                [ngClass]="sortDirection === 'asc' ? 'bi-arrow-up' : 'bi-arrow-down'"></i>
            </th>
            <!-- Producto Column -->
            <th scope="col" (click)="sortData('product')" class="cursor color-primary">
              Producto
              <i *ngIf="sortColumn === 'product'" class="bi"
                [ngClass]="sortDirection === 'asc' ? 'bi-arrow-up' : 'bi-arrow-down'"></i>
            </th>
            <!-- Motivo Column -->
            <th scope="col" (click)="sortData('reason_rejection')" class="cursor row_motivo color-primary text-center">
              Motivo
              <i *ngIf="sortColumn === 'reason_rejection'" class="bi"
                [ngClass]="sortDirection === 'asc' ? 'bi-arrow-up' : 'bi-arrow-down'"></i>
            </th>
            <!-- Interés Column -->
            <th scope="col" (click)="sortData('r.interest_date')" class="cursor row_interes color-primary">
              <i class="bi bi-calendar-check" [ngbTooltip]="'Interés'" placement="left"></i>
              <i *ngIf="sortColumn === 'r.interest_date'" class="bi"
                [ngClass]="sortDirection === 'asc' ? 'bi-arrow-up' : 'bi-arrow-down'"></i>
            </th>
            <!-- Precio Column -->
            <th scope="col" class="cursor row_precio_producto text-end color-primary" (click)="sortData('pvp')">
              Mi Precio
              <i *ngIf="sortColumn === 'pvp'" class="bi"
                [ngClass]="sortDirection === 'asc' ? 'bi-arrow-up' : 'bi-arrow-down'"></i>
            </th>
            <!-- Promo Propia Column -->
            <th scope="col" class="text-center row_promocion_propia cursor color-primary"
              (click)="sortData('own_promo')">
              <i *ngIf="sortColumn === 'own_promo'" class="bi"
                [ngClass]="sortDirection === 'asc' ? 'bi-arrow-up' : 'bi-arrow-down'"></i>
            </th>
            <!-- Competidor Column -->
            <th scope="col" class="text-end cursor color-primary" (click)="sortData('pvp_competitor')">
              Su Precio
              <i *ngIf="sortColumn === 'pvp_competitor'" class="bi"
                [ngClass]="sortDirection === 'asc' ? 'bi-arrow-up' : 'bi-arrow-down'"></i>
            </th>
            <!-- Promo Competidor Column -->
            <th scope="col" class="text-center cursor row_promocion_propia color-primary"
              (click)="sortData('competitor_promo')">
              <i *ngIf="sortColumn === 'competitor_promo'" class="bi"
                [ngClass]="sortDirection === 'asc' ? 'bi-arrow-up' : 'bi-arrow-down'"></i>
            </th>
            <!-- Competidor Column -->
            <th scope="col" (click)="sortData('competitor_id')" class="cursor row_select_competidor color-primary">
              Competidor
              <i *ngIf="sortColumn === 'competitor_id'" class="bi"
                [ngClass]="sortDirection === 'asc' ? 'bi-arrow-up' : 'bi-arrow-down'"></i>
            </th>
            <!-- Propuesta Agente Column -->
            <th scope="col" (click)="sortData('salesman_proposal')"
              class="cursor row_propuesta_agente pr-0 color-primary">
              <i class="bi bi-card-text" [ngbTooltip]="'Propuesta Agente'" placement="left"></i>
              <i *ngIf="sortColumn === 'salesman_proposal'" class="bi"
                [ngClass]="sortDirection === 'asc' ? 'bi-arrow-up' : 'bi-arrow-down'"></i>
            </th>
            <!-- Expand Column -->
            <th scope="col" class="text-center row_expand"></th>
          </tr>
        </thead>
        <tbody>
          <ng-container *ngFor="let row of dataSource">
            <tr (click)="selectReject(row.id)">
              <!-- Checkbox Column -->
              <td class="text-center px-2">
                <div class=" d-flex align-items-center justify-self-center">
                  <input type="checkbox" (click)="$event.stopPropagation()" (change)="onRowToggle(row)"
                    [checked]="isSelected(row)" [disabled]="isCheckboxDisabled(row)">

                </div>
              </td>
              <!-- Acción Correctora Column -->
              <td class="fondo_accionCorrectora">
                <!-- Mostrar como campos editables si tiene permisos -->
                <div *ngIf="canEditAccionCorrectora" class="d-flex align-items-center gap-1">
                  <!-- Campo para precio de promoción -->
                  <input type="number" class="form-control form-control-sm accion_correctora_precio color-primary"
                    [(ngModel)]="row.corrective_action_value" placeholder="0" min="0"
                    (input)="changeNumber($event, row)" />

                  <!-- Campo para símbolo de promoción -->
                  <select class="form-select form-select-sm accion_correctora_simbolo"
                    [(ngModel)]="row.corrective_action_symbol_id" (change)="changeSymbol($event, row)">
                    <option *ngFor="let simbolo of simbolos" [value]="simbolo.id">
                      {{ simbolo.symbol }}
                    </option>
                  </select>

                  <!-- Campo para acción correctora -->
                  <input type="text" class="truncate-text form-control form-control-sm color-primary"
                    [(ngModel)]="row.corrective_action_text" maxlength="50" placement="top" placeholder="Promoción"
                    (ngModelChange)="changeText($event, row)" [ngbTooltip]="tooltipText"
                    (mouseover)="applyTooltipIfTruncated($event, row.corrective_action_text)" />

                  <!-- campo de estado (siempre visible) -->
                  <div class="d-flex align-items-center justify-self-center">
                    <mobentis-corrective-action-status [statusId]="row.corrective_action_status_id"
                      [statusText]="row.corrective_action_status" [rejectionId]="row.id"
                      (statusChange)="onStatusChange($event, row)" [correctiveActionValue]="row.corrective_action_value"
                      [correctiveActionSymbolId]="row.corrective_action_symbol_id"
                      [correctiveActionText]="row.corrective_action_text"
                      [canEnviar]="canEnviarAccionCorrectora"></mobentis-corrective-action-status>
                  </div>
                </div>

                <!-- Mostrar como texto plano si NO tiene permisos -->
                <div *ngIf="!canEditAccionCorrectora" class="d-flex align-items-center justify-content-between gap-2 w-100">
                  <!-- Valor y símbolo -->
                  <span class="accion-correctora-readonly">
                    <strong>{{ row.corrective_action_value || '-' }}</strong>
                    <span>{{ row.corrective_action_symbol_id ? getSymbolText(row.corrective_action_symbol_id) : '' }}</span>
                  </span>
                  
                  <!-- Texto de acción correctora -->
                  <span class="accion-correctora-text" 
                    [ngbTooltip]="row.corrective_action_text"
                    container="body">
                    {{ row.corrective_action_text || '-' }}
                  </span>

                  <!-- Estado de acción correctora -->
                  <span class="accion-correctora-status" 
                    [ngClass]="{
                      'status-enviado': row.corrective_action_status_id === 2,
                      'status-pendiente': row.corrective_action_status_id === 1
                    }">
                    {{ row.corrective_action_status || '-' }}
                  </span>
                </div>
              </td>

              <!-- Estado Column -->
              <td class="">
                <!-- Mostrar como dropdown si tiene permisos -->
                <div *ngIf="canEditEstado" class="d-flex align-items-center gap-1">
                  <img [src]="getOptionImage(row.status_id)" alt="{{ getEstado(row.status_id) }} Image"
                    class="option-image">
                  <select (change)="changeEstado($event, row)" class="form-select form-select-sm text-center"
                    [(ngModel)]="row.status_id">
                    <option *ngFor="let estado of estados" [value]="estado.id">
                      {{ estado.name }}
                    </option>
                  </select>
                </div>
                <!-- Mostrar como texto plano si NO tiene permisos -->
                <div *ngIf="!canEditEstado" class="d-flex align-items-center gap-1">
                  <img [src]="getOptionImage(row.status_id)" alt="{{ getEstado(row.status_id) }} Image"
                    class="option-image">
                  <span class="text-center flex-grow-1">{{ getEstado(row.status_id) }}</span>
                </div>
              </td>
              <!-- Primer Rechazo Column -->
              <td class="">{{ row.last_rejection_date }}</td>
              <!-- Población Column -->
              <td class="">{{ row.city }}</td>
              <!-- Cliente Column -->
              <td class="row_cliente">
                <p [ngbTooltip]="tooltipText" (mouseover)="applyTooltipIfTruncated($event, row.customer_name)"
                  class="truncate-text m-0">
                  {{ row.customer_name }}
                </p>
              </td>
              <!-- Producto Column -->
              <td class="row_producto">
                <p [ngbTooltip]="tooltipText" (mouseover)="applyTooltipIfTruncated($event, row.product)"
                  class="truncate-text m-0">
                  {{ row.product }}
                </p>
              </td>
              <!-- Motivo Column -->
              <td class="text-center">
                <!-- Mostrar como dropdown si tiene permisos -->
                <select *ngIf="canEditMotivos" (change)="changeMotivo($event, row)" (mousedown)="capturePreviousValueReasonId(row)"
                  class="form-select form-select-sm column_motivo select_rechazo color-quaternary truncate-select"
                  [(ngModel)]="row.reason_rejection_id" [ngbTooltip]="tooltipText"
                  (mouseenter)="showTooltipForSelect($event, motivos_rechazo, 'id', 'name')"
                  (mouseleave)="tooltipText = null" #selectElement>
                  <option *ngFor="let motivo of motivos_rechazo;trackBy: trackByFn" [value]="motivo.id">
                    {{ motivo.name }}
                  </option>
                  <option [value]="0">Añadir Motivo</option>
                </select>
                <!-- Mostrar como texto plano si NO tiene permisos -->
                <span *ngIf="!canEditMotivos" [ngbTooltip]="getReasonName(row.reason_rejection_id)" class="truncate-text">
                  {{ getReasonName(row.reason_rejection_id) }}
                </span>
              </td>
              <!-- Fecha Interés Column -->
              <td class="text-success centrado_column row_fecha_interes">
                <i *ngIf="row.interest_date" class="bi bi-calendar-check promo-icon color-tertiary"
                  [ngbTooltip]="row.interest_date"></i>
              </td>
              <!-- Precio Column -->
              <td class="text-end row_precio_producto centrado_column">{{ row.pvp | decimales }} €</td>
              <!-- Promo Propia Column -->
              <td class="text-center centrado_column">
                <div *ngIf="row.has_own_promo" class="promo-icon-p color-tertiary" [ngbTooltip]="row.own_promo">P</div>
              </td>
              <!-- Precio Competidor Column -->
              <td class="text-end row_precio_competidor centrado_column">{{ row.pvp_competitor | decimales }} €</td>
              <!-- Promo Competidor Column -->
              <td class="text-center centrado_column">
                <div *ngIf="row.has_competitor_promo" class="promo-icon-p color-tertiary"
                  [ngbTooltip]="row.competitor_promo">P</div>
              </td>
              <!-- Competidor Column -->
              <td>
                <!-- Mostrar como dropdown si tiene permisos -->
                <select *ngIf="canEditCompetidor" (change)="changeCompetidor($event, row)" (mousedown)="capturePreviousValueCompetitorId(row)"
                  class="form-select form-select-sm row_select_competidor truncate-select"
                  [(ngModel)]="row.competitor_id" [ngbTooltip]="tooltipText"
                  (mouseenter)="showTooltipForSelect($event, row.competitors, 'id', 'name')"
                  (mouseleave)="tooltipText = null">
                  <option *ngFor="let competidor of row.competitors; trackBy: trackByFn" [value]="competidor.id">{{
                    competidor.name }}
                  </option>
                  <option value="0">Añadir Competidor</option>
                </select>
                <!-- Mostrar como texto plano si NO tiene permisos -->
                <span *ngIf="!canEditCompetidor" [ngbTooltip]="getCompetitorName(row.competitor_id, row.competitors)" class="truncate-text">
                  {{ getCompetitorName(row.competitor_id, row.competitors) }}
                </span>
              </td>
              <!-- Propuesta Agente Column -->
              <td class="row_propuesta_agente">
                <div class="propuesta-icon-wrapper">
                  <i *ngIf="row.salesman_proposal" [ngbTooltip]="row.salesman_proposal" 
                    placement="left" container="body"
                    class="bi bi-card-text"></i>
                </div>
              </td>

              <!-- Expand Column -->
              <td class="">
                <div class="d-flex gap-2 align-items-center justify-content-center">
                  <mobentis-btn-icon-file (btnClicked)="viewRechazo(row.customer_id)"></mobentis-btn-icon-file>
                  <mobentis-btn-icon-expand [isExpanded]="expandedElement === row"
                    (toggle)="expandedElement = (expandedElement === row ? null : row)"></mobentis-btn-icon-expand>
                </div>
              </td>
            </tr>


            <!-- Row Expanded Detail -->
            <ng-container *ngIf="expandedElement === row">
              <tr>
                <td [attr.colspan]="displayedColumns.length">
                  <div class="p-2">
                    <div class="row mb-2">
                      <div class="col-md-3 col-sm-6">
                        <strong>PVP:</strong> {{ row.pvp }} €
                      </div>
                      <div class="col-md-3 col-sm-6">
                        <strong>Promoción Propia:</strong> {{ row.own_promo }}
                      </div>
                      <div class="col-md-3 col-sm-6">
                        <strong>Precio Competidor:</strong> {{ row.pvp_competitor }} €
                      </div>
                      <div class="col-md-3 col-sm-6">
                        <strong>Promoción Competidor:</strong> {{ row.competitor_promo }}
                      </div>
                    </div>
                    <div class="row">
                      <div class="col-12">
                        <strong>Notas:</strong> {{ row.notes }}
                      </div>
                    </div>
                  </div>
                </td>
              </tr>
            </ng-container>
          </ng-container>
          <tr *ngIf="dataSource.length === 0">
            <td colspan="20" class="text-center">
              No hay datos
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <div class="d-flex justify-content-center {{cargando?'':'d-none'}}">
      <div class="spinner-border" role="status">
        <span class="sr-only">Loading...</span>
      </div>
    </div>
    <!-- Paginador -->
    <mobentis-pagination [totalItems]="totalItems" [itemsPerPage]="itemsPerPage" [currentPage]="currentPage"
      (pageChange)="onPageChange($event)" (itemsPerPageChanged)="onItemsPerPageChanged($event)">
    </mobentis-pagination>
  </div>
  <!-- END TABLA -->
</div>