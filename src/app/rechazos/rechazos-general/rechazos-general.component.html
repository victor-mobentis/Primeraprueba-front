<div class="screen background-light-gray d-flex flex-column">
  <div
    class="d-flex flex-column gap-2 flex-xl-row justify-content-between align-items-center  p-1 titulo bg-white w-100">
    <!-- titulo y icono -->
    <div class="d-flex align-items-center justify-content-start ">
      <mat-icon class="dark-gray">broken_image</mat-icon>
      <h1 class="mb-0 ps-2 dark-gray page-heading">Rechazos</h1>
    </div>
    <!-- Info Rechazos -->
    <div class="max-w-kpi">
      <app-kpi></app-kpi>
    </div>
    <!-- END Info Rechazos -->
  </div>
  <!-- TABLA -->
  <div class="mt-3 mx-2">
    <div class="d-flex flex-column flex-lg-row align-items-center justify-content-between gap-2">
      <div class="d-flex flex-column flex-lg-row gap-3 align-items-center">
        <!-- buscado -->
         <div class="input-group">
          <app-search-input [searchTerm]="searchTerm" (searchChange)="onSearch($event)"></app-search-input>
         </div>
        <!-- boton de filtros aplicados o limpiar -->
        <app-filter-container [componentId]="'rechazos-general'" [selectedFilters]="selectedFilters"
          (filtersChanged)="onFiltersChanged($event)">
        </app-filter-container>
      </div>
      <!-- boton de exportar y mapa -->
      <div class="d-flex align-items-center gap-2">
        <app-btn-export (formatSelected)="exportData($event)"></app-btn-export>
        <button class="btn btn-primary d-flex justify-content-center align-items-center" (click)="verEnMapa()">
          <i class="bi bi-geo-alt-fill"></i>
        </button>
      </div>
    </div>
    <div class="table-responsive">
      <table class="table table-sm">
        <thead>
          <tr class="">
            <!-- Checkbox Column -->
            <th scope="col" class="text-center p-2 row_checkboxy">
              <div class=" d-flex align-items-center justify-self-center">
                <input type="checkbox" (change)="masterToggle()" [checked]="selection.hasValue() && isAllSelected()"
                  [indeterminate]="selection.hasValue() && !isAllSelected()">
              </div>
            </th>
            <!-- Acción Correctora Column -->
            <th scope="col" class="text-center row_accion_correctora header-correctora background-color-primary">
              Convertir en oportunidad (% ó €
              + Promo)</th>
            <!-- Estado Column -->
            <th scope="col" class="text-center cursor select_estado color-primary " (click)="sortData('status')">
              Estado
              <i *ngIf="sortColumn === 'status'" class="bi"
                [ngClass]="sortDirection === 'asc' ? 'bi-arrow-up' : 'bi-arrow-down'"></i>
            </th>
            <!-- Primer Rechazo Fecha Column -->
            <th scope="col" class="cursor row_fecha color-primary" (click)="sortData('r.last_rejection_date')">
              Fecha
              <i *ngIf="sortColumn === 'r.last_rejection_date'" class="bi"
                [ngClass]="sortDirection === 'asc' ? 'bi-arrow-up' : 'bi-arrow-down'"></i>
            </th>
            <!-- Población Column -->
            <th scope="col" class="row_poblacion cursor color-primary" (click)="sortData('city')">
              Población
              <i *ngIf="sortColumn === 'city'" class="bi"
                [ngClass]="sortDirection === 'asc' ? 'bi-arrow-up' : 'bi-arrow-down'"></i>
            </th>
            <!-- Cliente Column -->
            <th scope="col" (click)="sortData('customer_name')" class="cursor color-primary">
              Cliente
              <i *ngIf="sortColumn === 'customer_name'" class="bi"
                [ngClass]="sortDirection === 'asc' ? 'bi-arrow-up' : 'bi-arrow-down'"></i>
            </th>
            <!-- Producto Column -->
            <th scope="col" (click)="sortData('product')" class="cursor color-primary">
              Producto
              <i *ngIf="sortColumn === 'product'" class="bi"
                [ngClass]="sortDirection === 'asc' ? 'bi-arrow-up' : 'bi-arrow-down'"></i>
            </th>
            <!-- Motivo Column -->
            <th scope="col" (click)="sortData('reason_rejection')" class="cursor row_motivo color-primary">
              Motivo
              <i *ngIf="sortColumn === 'reason_rejection'" class="bi"
                [ngClass]="sortDirection === 'asc' ? 'bi-arrow-up' : 'bi-arrow-down'"></i>
            </th>
            <!-- Interés Column -->
            <th scope="col" (click)="sortData('r.interest_date')" class="cursor row_interes color-primary">
              <i class="bi bi-calendar-check" [ngbTooltip]="'Interés'"></i>
              <i *ngIf="sortColumn === 'r.interest_date'" class="bi"
                [ngClass]="sortDirection === 'asc' ? 'bi-arrow-up' : 'bi-arrow-down'"></i>
            </th>
            <!-- Precio Column -->
            <th scope="col" class="cursor row_precio_producto text-end color-primary" (click)="sortData('pvp')">
              Mi Precio
              <i *ngIf="sortColumn === 'pvp'" class="bi"
                [ngClass]="sortDirection === 'asc' ? 'bi-arrow-up' : 'bi-arrow-down'"></i>
            </th>
            <!-- Promo Propia Column -->
            <th scope="col" class="text-center row_promocion_propia cursor color-primary"
              (click)="sortData('own_promo')">
              <i *ngIf="sortColumn === 'own_promo'" class="bi"
                [ngClass]="sortDirection === 'asc' ? 'bi-arrow-up' : 'bi-arrow-down'"></i>
            </th>
            <!-- Competidor Column -->
            <th scope="col" class="text-end cursor color-primary" (click)="sortData('pvp_competitor')">
              Su Precio
              <i *ngIf="sortColumn === 'pvp_competitor'" class="bi"
                [ngClass]="sortDirection === 'asc' ? 'bi-arrow-up' : 'bi-arrow-down'"></i>
            </th>
            <!-- Promo Competidor Column -->
            <th scope="col" class="text-center cursor row_promocion_propia color-primary"
              (click)="sortData('competitor_promo')">
              <i *ngIf="sortColumn === 'competitor_promo'" class="bi"
                [ngClass]="sortDirection === 'asc' ? 'bi-arrow-up' : 'bi-arrow-down'"></i>
            </th>
            <!-- Competidor Column -->
            <th scope="col" (click)="sortData('competitor_id')" class="cursor row_select_competidor color-primary">
              Competidor
              <i *ngIf="sortColumn === 'competitor_id'" class="bi"
                [ngClass]="sortDirection === 'asc' ? 'bi-arrow-up' : 'bi-arrow-down'"></i>
            </th>
            <!-- Propuesta Agente Column -->
            <th scope="col" (click)="sortData('salesman_proposal')"
              class="cursor row_propuesta_agente pr-0 color-primary">
              <i class="bi bi-card-text" [ngbTooltip]="'Propuesta Agente'"></i>
              <i *ngIf="sortColumn === 'salesman_proposal'" class="bi"
                [ngClass]="sortDirection === 'asc' ? 'bi-arrow-up' : 'bi-arrow-down'"></i>
            </th>
            <!-- Expand Column -->
            <th scope="col" class="text-center row_expand"></th>
          </tr>
        </thead>
        <tbody>
          <ng-container *ngFor="let row of dataSource">
            <tr>
              <!-- Checkbox Column -->
              <td class="text-center px-2">
                <div class=" d-flex align-items-center justify-self-center">
                  <input type="checkbox" (click)="$event.stopPropagation()" (change)="onRowToggle(row)"
                    [checked]="isSelected(row)" [disabled]="isCheckboxDisabled(row)">
                </div>
              </td>
              <!-- Acción Correctora Column -->
              <td class="fondo_accionCorrectora">
                <div class="d-flex align-items-center gap-1">
                  <!-- Campo para precio de promoción -->
                  <input type="number" class="form-control form-control-sm accion_correctora_precio text-success"
                    [(ngModel)]="row.corrective_action_value" placeholder="0" min="0" />

                  <!-- Campo para símbolo de promoción -->
                  <select class="form-select form-select-sm accion_correctora_simbolo"
                    [(ngModel)]="row.corrective_action_symbol_id" (change)="updateSymbol(row)">
                    <option *ngFor="let simbolo of simbolos" [value]="simbolo.id">
                      {{ simbolo.symbol }}
                    </option>
                  </select>

                  <!-- Campo para acción correctora -->
                  <input type="text" class="form-control form-control-sm text-success"
                    [(ngModel)]="row.corrective_action_text" maxlength="50" placement="top" placeholder="Promoción"
                    [ngbTooltip]="row.corrective_action_text" />
                  <div class=" d-flex align-items-center justify-self-center">
                    <input type="checkbox" (click)="$event.stopPropagation()" [checked]="row.corrective_action_sent" />
                  </div>
                </div>
              </td>

              <!-- Estado Column -->
              <td class="text-center">
                <div class="d-flex align-items-center gap-1 justify-content-center">
                  <img [src]="getOptionImage(row.status_id)" alt="{{ getEstado(row.status_id) }} Image"
                    class="option-image">
                  <select (change)="changeEstado($event, row)" class="form-select form-select-sm "
                    [(ngModel)]="row.status_id" (ngModelChange)="actualizarEstados(row)">
                    <option *ngFor="let estado of estados" [value]="estado.id">
                      {{ estado.name }}
                    </option>
                  </select>
                </div>
              </td>
              <!-- Primer Rechazo Column -->
              <td class="">{{ row.last_rejection_date }}</td>
              <!-- Población Column -->
              <td class="">{{ row.city }}</td>
              <!-- Cliente Column -->
              <td class="row_cliente">
                <p [ngbTooltip]="tooltipText" (mouseover)="applyTooltipIfTruncated($event, row.customer_name)"
                  class="truncate-text m-0">
                  {{ row.customer_name }}
                </p>
              </td>
              <!-- Producto Column -->
              <td class="row_producto">
                <p [ngbTooltip]="tooltipText" (mouseover)="applyTooltipIfTruncated($event, row.product)"
                  class="truncate-text m-0">
                  {{ row.product }}
                </p>
              </td>
              <!-- Motivo Column -->
              <td class="text-center">
                <select (change)="changeMotivo($event, row)"
                  class="form-select form-select-sm column_motivo select_rechazo color-quaternary"
                  [(ngModel)]="row.reason_rejection_id" [ngbTooltip]="row.reason_rejection">
                  <option class="color-quaternary" *ngFor="let motivo of motivos_rechazo" [value]="motivo.id">{{
                    motivo.name }}</option>
                  <option class="color-quaternary" [value]="0">Añadir Motivo</option>
                </select>
              </td>
              <!-- Fecha Interés Column -->
              <td class="text-success centrado_column row_fecha_interes">
                <i *ngIf="row.interest_date" class="bi bi-calendar-check promo-icon"
                  [ngbTooltip]="row.interest_date"></i>
              </td>
              <!-- Precio Column -->
              <td class="text-end row_precio_producto centrado_column">{{ row.pvp | decimales }} €</td>
              <!-- Promo Propia Column -->
              <td class="text-center centrado_column">
                <i *ngIf="row.has_own_promo" class="promo-icon-p" [ngbTooltip]="row.own_promo">P</i>
              </td>
              <!-- Precio Competidor Column -->
              <td class="text-end row_precio_competidor centrado_column">{{ row.pvp_competitor | decimales }} €</td>
              <!-- Promo Competidor Column -->
              <td class="text-center centrado_column">
                <i *ngIf="row.has_competitor_promo" class="promo-icon-p" [ngbTooltip]="row.competitor_promo">P</i>
              </td>
              <!-- Competidor Column -->
              <td>
                <select (change)="changeCompetidor($event, row)"
                  class="form-select form-select-sm row_select_competidor" [(ngModel)]="row.competitor_id"
                  [ngbTooltip]="row.competitor_name">
                  <option *ngFor="let competidor of competidores" [value]="competidor.id">{{ competidor.name }}</option>
                  <option value="0">Añadir Competidor</option>
                </select>
              </td>
              <!-- Propuesta Agente Column -->
              <td class="row_propuesta_agente">
                <i *ngIf="row.salesman_proposal" [ngbTooltip]="row.salesman_proposal" placement="top" class="bi bi-card-text"></i>
              </td>

              <!-- Expand Column -->
              <td class="">
                <div class="d-flex gap-2 align-items-center justify-content-center">
                  <app-btn-icon-file (btnClicked)="viewRechazo(row.customer_id)"></app-btn-icon-file>
                  <app-btn-icon-expand [isExpanded]="expandedElement === row"
                    (toggle)="expandedElement = (expandedElement === row ? null : row)"></app-btn-icon-expand>
                </div>
              </td>
            </tr>


            <!-- Row Expanded Detail -->
            <ng-container *ngIf="expandedElement === row">
              <tr>
                <td [attr.colspan]="displayedColumns.length">
                  <div class="p-2">
                    <div class="row mb-2">
                      <div class="col-md-3 col-sm-6">
                        <strong>PVP:</strong> {{ row.pvp }} €
                      </div>
                      <div class="col-md-3 col-sm-6">
                        <strong>Promoción Propia:</strong> {{ row.own_promo }}
                      </div>
                      <div class="col-md-3 col-sm-6">
                        <strong>Precio Competidor:</strong> {{ row.pvp_competitor }} €
                      </div>
                      <div class="col-md-3 col-sm-6">
                        <strong>Promoción Competidor:</strong> {{ row.competitor_promo }}
                      </div>
                    </div>
                    <div class="row">
                      <div class="col-12">
                        <strong>Notas:</strong> {{ row.notes }}
                      </div>
                    </div>
                  </div>
                </td>
              </tr>
            </ng-container>
          </ng-container>
          <tr *ngIf="dataSource.length === 0">
            <td colspan="20" class="text-center">
              No hay datos
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <!-- Paginador -->
    <app-pagination [totalItems]="totalItems" [itemsPerPage]="itemsPerPage" [currentPage]="currentPage"
      (pageChange)="onPageChange($event)" (itemsPerPageChanged)="onItemsPerPageChanged($event)">
    </app-pagination>
  </div>
  <!-- END TABLA -->
</div>