<div class="screen background-light-gray d-flex flex-column">
  <div class="separador-superior"></div>
  <div class="d-flex flex-column gap-2 flex-xl-row justify-content-between align-items-center mt-3  p-2 titulo bg-white">
    <!-- titulo y icono -->
    <div class="d-flex align-items-center justify-content-start ">
      <mat-icon class="dark-gray">broken_image</mat-icon>
      <h1 class="mb-0 ps-2 dark-gray page-heading">Rechazos</h1>
    </div>
    <!-- Info Rechazos -->
    <div class="">
      <app-kpi></app-kpi>
    </div>
    <!-- END Info Rechazos -->
  </div>
  <!-- TABLA -->
  <div class="mt-3 mx-2 main">
    <div class="d-flex align-items-center justify-content-between mb-1">
      <div class="d-flex gap-3 align-items-center">
        <!-- buscado -->
        <div class="input-group" id="busqueda">
          <input class="form-control border-end-0 border" type="search" placeholder="Buscar..."
            id="example-search-input" [(ngModel)]="searchTerm" (keyup.enter)="buscar()"
            (ngModelChange)="onSearchTermChange()">
          <span class="input-group-append">
            <button class="btn btn-outline-secondary bg-white border-start-0 border-bottom-0 border ms-n5" type="button"
              (click)="buscar()">
              <i class="fa fa-search"></i>
            </button>
          </span>
        </div>
        <!-- boton de filtros aplicados o limpiar -->
        <app-filter-container [componentId]="'rechazos-general'" (filtersChanged)="onFiltersChanged($event)">
        </app-filter-container>
      </div>
      <!-- botones y filtros -->
      <div class="d-flex align-items-center gap-2">
        <div class="btn-group" role="group">
          <button type="button" class="btn btn-azul-claro" (click)="exportar_rechazos()">Exportar</button>
          <button type="button" class="btn btn-gris-claro dropdown-toggle" data-bs-toggle="dropdown"
            aria-expanded="false">
            {{ selectedOption }}
          </button>
          <ul class="dropdown-menu">
            <li><button class="dropdown-item" (click)="updateOption('Excel')">Excel</button></li>
            <li><button class="dropdown-item" (click)="updateOption('CSV')">CSV</button></li>
            <li><button class="dropdown-item" (click)="updateOption('Json')">Json</button></li>
          </ul>
        </div>
        <button class="btn btn-color d-flex justify-content-center align-items-center" (click)="verEnMapa()">
          <i class="bi bi-geo-alt-fill"></i>
        </button>
      </div>
    </div>
    <div class="table-responsive">
      <table class="table table-hover table-sm my-3">
        <thead>
          <tr class="">
            <!-- Checkbox Column -->
            <th scope="col" class="text-center p-2">
              <div class=" d-flex align-items-center justify-self-center">
                <input type="checkbox" (change)="masterToggle()" [checked]="selection.hasValue() && isAllSelected()"
                  [indeterminate]="selection.hasValue() && !isAllSelected()">
              </div>
            </th>
            <!-- Acción Correctora Column -->
            <th scope="col" class="text-center header-correctora">Convertir en oportunidad (% ó € + Promo)</th>
            <!-- Estado Column -->
            <th scope="col" class="text-center cursor" (click)="sortData('status')">
              Estado
              <i *ngIf="sortColumn === 'status'" class="bi"
                [ngClass]="sortDirection === 'asc' ? 'bi-arrow-up' : 'bi-arrow-down'"></i>
            </th>
            <!-- Primer Rechazo Fecha Column -->
            <th scope="col" class="cursor" (click)="sortData('r.last_rejection_date')">
              Fecha
              <i *ngIf="sortColumn === 'r.last_rejection_date'" class="bi"
                [ngClass]="sortDirection === 'asc' ? 'bi-arrow-up' : 'bi-arrow-down'"></i>
            </th>
            <!-- Población Column -->
            <th scope="col" class="row_poblacion cursor" (click)="sortData('city')">
              Población
              <i *ngIf="sortColumn === 'city'" class="bi"
                [ngClass]="sortDirection === 'asc' ? 'bi-arrow-up' : 'bi-arrow-down'"></i>
            </th>
            <!-- Cliente Column -->
            <th scope="col" (click)="sortData('customer_name')" class="cursor">
              Cliente
              <i *ngIf="sortColumn === 'customer_name'" class="bi"
                [ngClass]="sortDirection === 'asc' ? 'bi-arrow-up' : 'bi-arrow-down'"></i>
            </th>
            <!-- Producto Column -->
            <th scope="col" (click)="sortData('product')" class="cursor">
              Producto
              <i *ngIf="sortColumn === 'product'" class="bi"
                [ngClass]="sortDirection === 'asc' ? 'bi-arrow-up' : 'bi-arrow-down'"></i>
            </th>
            <!-- Motivo Column -->
            <th scope="col" (click)="sortData('reason_rejection')" class="cursor">
              Motivo
              <i *ngIf="sortColumn === 'reason_rejection'" class="bi"
                [ngClass]="sortDirection === 'asc' ? 'bi-arrow-up' : 'bi-arrow-down'"></i>
            </th>
            <!-- Interés Column -->
            <th scope="col" (click)="sortData('r.interest_date')" class="cursor text-center column-interes">
              <i class="bi bi-calendar-check" [ngbTooltip]="'Interés'"></i>
              <i *ngIf="sortColumn === 'r.interest_date'" class="bi"
                [ngClass]="sortDirection === 'asc' ? 'bi-arrow-up' : 'bi-arrow-down'"></i>
            </th>
            <!-- Precio Column -->
            <th scope="col" class="text-end cursor" (click)="sortData('pvp')">
              Mi Precio
              <i *ngIf="sortColumn === 'pvp'" class="bi"
                [ngClass]="sortDirection === 'asc' ? 'bi-arrow-up' : 'bi-arrow-down'"></i>
            </th>
            <!-- Promo Propia Column -->
            <th scope="col" class="text-center cursor" (click)="sortData('own_promo')">
              <i *ngIf="sortColumn === 'own_promo'" class="bi"
                [ngClass]="sortDirection === 'asc' ? 'bi-arrow-up' : 'bi-arrow-down'"></i>
            </th>
            <!-- Competidor Column -->
            <th scope="col" class="text-end cursor" (click)="sortData('pvp_competitor')">
              Su Precio
              <i *ngIf="sortColumn === 'pvp_competitor'" class="bi"
                [ngClass]="sortDirection === 'asc' ? 'bi-arrow-up' : 'bi-arrow-down'"></i>
            </th>
            <!-- Promo Competidor Column -->
            <th scope="col" class="text-center cursor" (click)="sortData('competitor_promo')">
              <i *ngIf="sortColumn === 'competitor_promo'" class="bi"
                [ngClass]="sortDirection === 'asc' ? 'bi-arrow-up' : 'bi-arrow-down'"></i>
            </th>
            <!-- Competidor Column -->
            <th scope="col" (click)="sortData('competitor_id')" class="cursor">
              Competidor
              <i *ngIf="sortColumn === 'competitor_id'" class="bi"
                [ngClass]="sortDirection === 'asc' ? 'bi-arrow-up' : 'bi-arrow-down'"></i>
            </th>
            <!-- Propuesta Agente Column -->
            <th scope="col" (click)="sortData('salesman_proposal')" class="cursor px-0">
              <i class="bi bi-card-text" [ngbTooltip]="'Propuesta Agente'"></i>
              <i *ngIf="sortColumn === 'salesman_proposal'" class="bi"
                [ngClass]="sortDirection === 'asc' ? 'bi-arrow-up' : 'bi-arrow-down'"></i>
            </th>
            
            <!-- columna ficha -->
            <th scope="col" class="text-center">Cliente</th>
            <!-- Expand Column -->
            <th scope="col" class="text-center"></th>
          </tr>
        </thead>
        <tbody>
          <ng-container *ngFor="let row of dataSource">
            <tr>
              <!-- Checkbox Column -->
              <td class="text-center px-2">
                <div class=" d-flex align-items-center justify-self-center">
                  <input type="checkbox" (click)="$event.stopPropagation()" (change)="onRowToggle(row)"
                    [checked]="isSelected(row)" [disabled]="isCheckboxDisabled(row)">
                </div>
              </td>
              <!-- Acción Correctora Column -->
              <td class="fondo_accionCorrectora">
                <div class="d-flex align-items-center gap-1">
                  <!-- Campo para precio de promoción -->
                  <input type="number" class="form-control form-control-sm accion_correctora_precio text-success"
                    [(ngModel)]="row.corrective_action_value" placeholder="0" min="0" />

                  <!-- Campo para símbolo de promoción -->
                  <select class="form-select form-select-sm accion_correctora_simbolo"
                    [(ngModel)]="row.corrective_action_symbol_id" (change)="updateSymbol(row)">
                    <option *ngFor="let simbolo of simbolos" [value]="simbolo.id">
                      {{ simbolo.symbol }}
                    </option>
                  </select>

                  <!-- Campo para acción correctora -->
                  <input type="text" class="form-control form-control-sm row_accion_correctora text-success"
                    [(ngModel)]="row.corrective_action_text" maxlength="50" placement="top" placeholder="Promoción"
                    [ngbTooltip]="row.corrective_action_text" />
                    <div class=" d-flex align-items-center justify-self-center">
                      <input type="checkbox" (click)="$event.stopPropagation()" [checked]="row.corrective_action_sent" />
                    </div>
                </div>
              </td>
            
              <!-- Estado Column -->
              <td class="text-center">
                <div class="d-flex align-items-center gap-1 justify-content-center">
                  <img [src]="getOptionImage(row.status_id)" alt="{{ getEstado(row.status_id) }} Image"
                    class="option-image">
                  <select (change)="changeEstado($event, row)" class="form-select form-select-sm select_estado"
                    [(ngModel)]="row.status_id" (ngModelChange)="actualizarEstados(row)">
                    <option *ngFor="let estado of estados" [value]="estado.id">
                      {{ estado.name }}
                    </option>
                  </select>
                </div>
              </td>
              <!-- Primer Rechazo Column -->
              <td class="">{{ row.last_rejection_date }}</td>
              <!-- Población Column -->
              <td class="">{{ row.city }}</td>
              <!-- Cliente Column -->
              <td class="row_cliente">
                <span [ngbTooltip]="tooltipText" (mouseover)="applyTooltipIfTruncated($event, row.customer_name)"
                  class="truncate-text">
                  {{ row.customer_name }}
                </span>
              </td>
              <!-- Producto Column -->
              <td class="row_producto">
                <span [ngbTooltip]="tooltipText" (mouseover)="applyTooltipIfTruncated($event, row.product)"
                  class="truncate-text">
                  {{ row.product }}
                </span>
              </td>
              <!-- Motivo Column -->
              <td class="text-center">
                <select (change)="changeMotivo($event, row)"
                  class="form-select form-select-sm text-motivos select_rechazo" [(ngModel)]="row.reason_rejection_id"
                  [ngbTooltip]="row.reason_rejection">
                  <option *ngFor="let motivo of motivos_rechazo" [value]="motivo.id">{{ motivo.name }}</option>
                </select>
              </td>
              <!-- Fecha Interés Column -->
              <td class="text-success centrado_column row_fecha_interes">
                <i *ngIf="row.interest_date" class="bi bi-calendar-check promo-icon"
                  [ngbTooltip]="row.interest_date"></i>
              </td>
              <!-- Precio Column -->
              <td class="text-end row_precio_producto centrado_column">{{ row.pvp | decimales }} €</td>
              <!-- Promo Propia Column -->
              <td class="text-center centrado_column">
                <i *ngIf="row.has_own_promo" class="promo-icon" [ngbTooltip]="row.own_promo">P</i>
              </td>
              <!-- Competidor Column -->
              <td class="text-end row_precio_competidor centrado_column">{{ row.pvp_competitor | decimales }} €</td>
              <!-- Promo Competidor Column -->
              <td class="text-center centrado_column">
                <i *ngIf="row.has_competitor_promo" class="promo-icon" [ngbTooltip]="row.competitor_promo">P</i>
              </td>
              <!-- Competidor Column -->
              <td>
                <select (change)="changeCompetidor($event, row)"
                  class="form-select form-select-sm row_select_competidor" [(ngModel)]="row.competitor_id"
                  [ngbTooltip]="row.competitor_name">
                  <option *ngFor="let competidor of competidores" [value]="competidor.id">{{ competidor.name }}</option>
                </select>
              </td>
              <!-- Propuesta Agente Column -->
              <td class="row_propuesta_agente">
                <i *ngIf="row.salesman_proposal" [ngbTooltip]="row.salesman_proposal" class="bi bi-card-text"></i>
              </td>
              
              <!-- ficha column -->
              <td class="text-center">
                <i class="bi bi-eye-fill fs-5 icon_color cursor px-0" (click)="viewRechazo(row.customer_id)"></i>
              </td>
              <!-- Expand Column -->
              <td class="text-center">
                <button class="btn btn-color py-0 px-1 text-white"
                  (click)="expandedElement = (expandedElement === row ? null : row)">
                  <i class="bi" [ngClass]="expandedElement === row ? 'bi-chevron-up' : 'bi bi-three-dots'"></i>
                </button>
              </td>
            </tr>


            <!-- Row Expanded Detail -->
            <ng-container *ngIf="expandedElement === row">
              <tr>
                <td [attr.colspan]="displayedColumns.length">
                  <div class="p-2">
                    <div class="row mb-2">
                      <div class="col-md-3 col-sm-6">
                        <strong>PVP:</strong> {{ row.pvp }} €
                      </div>
                      <div class="col-md-3 col-sm-6">
                        <strong>Promoción Propia:</strong> {{ row.own_promo }}
                      </div>
                      <div class="col-md-3 col-sm-6">
                        <strong>Precio Competidor:</strong> {{ row.pvp_competitor }} €
                      </div>
                      <div class="col-md-3 col-sm-6">
                        <strong>Promoción Competidor:</strong> {{ row.competitor_promo }}
                      </div>
                    </div>
                    <div class="row">
                      <div class="col-12">
                        <strong>Notas:</strong> {{ row.notes }}
                      </div>
                    </div>
                  </div>
                </td>
              </tr>
            </ng-container>
          </ng-container>
          <tr *ngIf="dataSource.length === 0">
            <td colspan="20" class="text-center">
              No hay datos
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <!-- Paginador -->
    <app-pagination [totalItems]="totalItems" [itemsPerPage]="itemsPerPage" [currentPage]="currentPage"
      (pageChange)="onPageChange($event)" (itemsPerPageChanged)="onItemsPerPageChanged($event)">
    </app-pagination>
  </div>
  <!-- END TABLA -->
</div>