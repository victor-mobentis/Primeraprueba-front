<mat-drawer-container class="screen">
  <div class="d-flex align-items-center justify-content-start py-3 m-3">
    <mat-icon class="color-dark">broken_image</mat-icon>
    <h1 class="mb-0 ps-2 color-dark page-heading">Converter</h1>
  </div>
  <!-- Info Rechazos -->
  <div class="mx-3 details d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
    <div class="bg-white text-center rounded-3 d-flex justify-content-evenly align-items-center gap-2 px-3">
      <div class="d-flex flex-column m-1">
        <h3 class="m-0 fw-bold">{{estadosRechazoCount.cantidad_rechazo}}</h3>
        <span class="text-muted custom-bold ">Rechazado</span>
      </div>
      <div class="border my-2" style="height: 45px;"></div>
      <div class="d-flex flex-column m-1">
        <h3 class="m-0 fw-bold">{{estadosRechazoCount.cantidad_enProceso}}</h3>
        <span class="text-muted custom-bold">En proceso</span>
      </div>
      <div class="border my-2" style="height: 45px;"></div>
      <div class="d-flex flex-column m-1">
        <h3 class="m-0 fw-bold">{{estadosRechazoCount.cantidad_noAplica}}</h3>
        <span class="text-muted custom-bold">No Aplica</span>
      </div>
      <div class="border my-2" style="height: 45px;"></div>
      <div class="d-flex flex-column m-1">
        <h3 class="m-0 fw-bold">{{estadosRechazoCount.cantidad_aceptado}}</h3>
        <span class="text-muted custom-bold">Vendido</span>
      </div>
    </div>
    <div class="d-flex align-items-center gap-2">
      <button matTooltip="Ver en Mapa" class="btn btn-secondary d-flex justify-content-center align-items-center"
        (click)="verEnMapa()">
        <mat-icon class="p-0 m-0">location_on</mat-icon>
      </button>
      <button matTooltip="Ver Filtros" class="btn btn-secondary d-flex align-items-center" (click)="drawer.toggle()">
        <mat-icon class="p-0 m-0">filter_list_alt</mat-icon>
      </button>
    </div>
  </div>
  <!-- END Info Rechazos -->
  <!-- TABLA -->
  <div class="mat-elevation-z2 m-3">
    <div class="table-wrapper">
      <table class="converter-table" mat-table [dataSource]="dataSource" matSort multiTemplateDataRows>
        <!-- Checkbox Column -->
        <ng-container matColumnDef="select" sticky>
          <th mat-header-cell *matHeaderCellDef class="sticky-header">
            <mat-checkbox color="primary" (change)="$event ? masterToggle() : null"
              [checked]="selection.hasValue() && isAllSelected()"
              [indeterminate]="selection.hasValue() && !isAllSelected()"></mat-checkbox>
          </th>
          <td mat-cell *matCellDef="let row">
            <mat-checkbox color="primary" (click)="$event.stopPropagation()"
              (change)="$event ? selection.toggle(row) : null" [checked]="selection.isSelected(row)"></mat-checkbox>
          </td>
        </ng-container>
        <!-- Estado Column -->
        <ng-container matColumnDef="estado">
          <th mat-header-cell *matHeaderCellDef mat-sort-header class="">Estado</th>
          <td mat-cell *matCellDef="let row" class="estado-cell">
            <div class="d-flex align-items-center justify-content-center gap-2">
              <div class="form-group estado-form-group">
                <mat-form-field appearance="outline" subscriptSizing="dynamic" class="estado-form-field">
                  <mat-select [(ngModel)]="row.estado" name="estado-{{row.rechazo_id}}" class="small-height-select"
                    (selectionChange)="actualizarEstados(row)">
                    <mat-select-trigger>
                      <img [src]="getOptionImage(row.estado)" alt="{{ row.estado }} Image" class="option-image">
                      {{ row.estado }}
                    </mat-select-trigger>
                    <mat-option *ngFor="let estado of estados" [value]="estado.estado">
                      <img [src]="getOptionImage(estado.estado)" alt="{{ estado.estado }} Image" class="option-image">
                      {{ estado.estado }}
                    </mat-option>
                  </mat-select>
                </mat-form-field>
              </div>
            </div>
          </td>
        </ng-container>

        <!-- Poblacion Column -->
        <ng-container matColumnDef="poblacion">
          <th mat-header-cell *matHeaderCellDef mat-sort-header class=""> Población </th>
          <td mat-cell *matCellDef="let row" matTooltip="{{row.poblacion}}"
            [matTooltipDisabled]="row.poblacion?.length <= 16"> {{ row.poblacion }} </td>
        </ng-container>
        <!-- Producto Column -->
        <ng-container matColumnDef="producto">
          <th mat-header-cell *matHeaderCellDef mat-sort-header class=""> Producto </th>
          <td mat-cell *matCellDef="let row" matTooltip="{{row.producto}}"
            [matTooltipDisabled]="row.producto?.length <= 32"> {{ row.producto }} </td>
        </ng-container>
        <!-- Cliente Column -->
        <ng-container matColumnDef="cliente">
          <th mat-header-cell *matHeaderCellDef mat-sort-header> Cliente </th>
          <td mat-cell *matCellDef="let row" matTooltip="{{row.cliente}}"
            [matTooltipDisabled]="row.cliente?.length <= 32"> {{ row.cliente }} </td>
        </ng-container>
        <!-- columna de subfamilia -->
        <ng-container matColumnDef="nombre_subfamilia">
          <th mat-header-cell *matHeaderCellDef mat-sort-header class=""> Subfamilia </th>
          <td mat-cell *matCellDef="let row" matTooltip="{{row.nombre_subfamilia}}"
            [matTooltipDisabled]="row.nombre_subfamilia?.length <= 22"> {{ row.nombre_subfamilia }} </td>
        </ng-container>
        <!-- Rechazo Column -->
        <ng-container matColumnDef="tipo_rechazo">
          <th mat-header-cell *matHeaderCellDef mat-sort-header class=""> Rechazo </th>
          <td class="color-rechazo" mat-cell *matCellDef="let row">
            <div class="d-flex align-items-center justify-content-center gap-2">
              <div class="form-group estado-form-group">
                <mat-form-field appearance="outline" subscriptSizing="dynamic" class="estado-form-field color-rechazo">
                  <mat-select [(ngModel)]="row.estado" name="estado-{{row.rechazo_id}}" class="small-height-select"
                    (selectionChange)="actualizarEstados(row)">
                    <mat-option *ngFor="let estado of estados" [value]="estado.estado">
                      {{ estado.estado }}
                    </mat-option>
                  </mat-select>
                </mat-form-field>
              </div>
            </div>
          </td>
        </ng-container>
        <!-- PVP Column -->
        <ng-container matColumnDef="precio_producto">
          <th mat-header-cell *matHeaderCellDef mat-sort-header class="text-end"> Precio </th>
          <td class="text-end" mat-cell *matCellDef="let row"> {{ row.precio_producto}} € </td>
        </ng-container>
        <!-- promo_propia Column -->
        <ng-container matColumnDef="promo_propia">
          <th mat-header-cell *matHeaderCellDef mat-sort-header class=""> </th>
          <td mat-cell *matCellDef="let row"> <mat-icon class="promo-icon">P</mat-icon> </td>
        </ng-container>
        <!-- Comp Column -->
        <ng-container matColumnDef="precio_competidor">
          <th mat-header-cell *matHeaderCellDef mat-sort-header class="text-end"> Comp. </th>
          <td mat-cell *matCellDef="let row" class="text-end"> {{ row.precio_competidor }}€ </td>
        </ng-container>
        <!-- promo_propia Column -->
        <ng-container matColumnDef="promo_competidor">
          <th mat-header-cell *matHeaderCellDef mat-sort-header class="text-center"> </th>
          <td mat-cell *matCellDef="let row" class="text-center"> <mat-icon class="promo-icon">P</mat-icon> </td>
        </ng-container>
        <!-- Competidor Column -->
        <ng-container matColumnDef="competidor">
          <th mat-header-cell *matHeaderCellDef mat-sort-header class=""> Competidor </th>
          <td mat-cell *matCellDef="let row">
            <div class="d-flex align-items-center justify-content-center gap-2">
              <div class="form-group estado-form-group">
                <mat-form-field appearance="outline" subscriptSizing="dynamic" class="estado-form-field color-rechazo">
                  <mat-select [(ngModel)]="row.competidor" name="estado-{{row.rechazo_id}}" class="small-height-select">
                    <mat-option *ngFor="let competidor of competidores" [value]="competidor.id">
                      {{ competidor.nombre }}
                    </mat-option>
                  </mat-select>
                </mat-form-field>
              </div>
            </div>
          </td>
        </ng-container>
        <!-- Acción Correctora Column -->
        <ng-container matColumnDef="accion_correctora">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Acción Correctora</th>
          <td mat-cell *matCellDef="let row" class="color-accioncorrectora">
            <div class="editable-cell d-flex align-items-center">
              <!-- Campo para precio de promoción -->
              <mat-form-field appearance="outline" class="small-height-field" subscriptSizing="dynamic">
                <input matInput [(ngModel)]="row.pvp_es_promocion_precio" type="number" placeholder="Precio"
                  class="no-padding" />
              </mat-form-field>

              <!-- Campo para símbolo de promoción -->
              <mat-form-field appearance="outline" class="width-select-simbolo" subscriptSizing="dynamic">
                <mat-select [(ngModel)]="row.id_simbolo" class="small-height-select"
                  (selectionChange)="updateSymbol(row)">
                  <mat-option *ngFor="let simbolo of simbolos" [value]="simbolo.id">
                    {{ simbolo.simbolo }}
                  </mat-option>
                </mat-select>
              </mat-form-field>

              <!-- Campo para acción correctora -->
              <mat-form-field appearance="outline" class="large-height-field" subscriptSizing="dynamic">
                <input matInput [(ngModel)]="row.accion_correctora" maxlength="50" placeholder="Acción Correctora" />
              </mat-form-field>
            </div>
          </td>
        </ng-container>
        <!-- Propuesta agente Column -->
        <ng-container matColumnDef="propuesta_agente">
          <th mat-header-cell *matHeaderCellDef mat-sort-header> Propuesta Agente </th>
          <td mat-cell *matCellDef="let row" matTooltip="{{row.propuesta_agente}}"
            [matTooltipDisabled]="row.propuesta_agente?.length <= 25"> {{ row.propuesta_agente }} </td>
        </ng-container>
        <!-- Fecha interes -->
        <ng-container matColumnDef="interes">
          <th mat-header-cell *matHeaderCellDef mat-sort-header class=""> Interés </th>
          <td mat-cell *matCellDef="let row"> {{ row.competidor }} </td>
        </ng-container>

        <ng-container matColumnDef="expand" stickyEnd>
          <th class="sticky-header" mat-header-cell *matHeaderCellDef aria-label="row actions"></th>
          <td class="text-center" mat-cell *matCellDef="let element">
            <button mat-icon-button aria-label="expand row"
              (click)="(expandedElement = expandedElement === element ? null : element); $event.stopPropagation()">
              <mat-icon *ngIf="expandedElement !== element">keyboard_arrow_down</mat-icon>
              <mat-icon *ngIf="expandedElement === element">keyboard_arrow_up</mat-icon>
            </button>
          </td>
        </ng-container>
        <ng-container matColumnDef="expandedDetail">
          <td mat-cell *matCellDef="let element" [attr.colspan]="displayedColumns.length">
            <div [@detailExpand]="element === expandedElement ? 'expanded' : 'collapsed'">
              <div class="d-flex mb-2">
                <!-- Campo PVP -->
                <div class="col-3">
                  <strong>PVP:</strong> <p>{{ element.PVP }}€</p>>
                </div>

                <!-- Promoción Propia -->
                <div class="col-3">
                  <strong>Promoción Propia:</strong> <p>{{ "element.promocion_propia" }}</p>
                </div>

                <!-- Precio del Competidor -->
                <div class="col-3">
                  <strong>Precio Competidor:</strong> <p>{{ element.precio_competidor }}€</p>
                </div>

                <!-- Promoción del Competidor -->
                <div class="col-3">
                  <strong>Promoción Competidor:</strong> {{ "element.promocion_competidor" }}
                </div>
              </div>

              <!-- Notas -->
              <div class="mt-2">
                <strong>Notas:</strong>
                <p>{{ "notas" }}</p>
              </div>
            </div>
          </td>
        </ng-container>
        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let element; columns: displayedColumns;" class="example-element-row"
          [class.example-expanded-row]="expandedElement === element">
        </tr>
        <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="example-detail-row"></tr>
        <tr class="mat-row" *matNoDataRow>
          <td class="mat-cell" colspan="4">No hay datos que mostrar</td>
        </tr>
      </table>
    </div>
    <mat-paginator [pageSizeOptions]="[10, 25, 50, 100]" [pageSize]="10" showFirstLastButtons></mat-paginator>
  </div>
  <!-- END TABLA -->
  <!-- menu derecho -->
  <mat-drawer #drawer class="sidenav px-3" mode="over" position="end">
    <div class="d-flex align-items-center my-4 gap-3">
      <mat-icon>filter_list_alt</mat-icon>
      <h2 class="my-0">Filtro de Rechazos</h2>
    </div>
    <form [formGroup]="form" (ngSubmit)="applyFilter()" class="d-flex flex-column gap-3">
      <div class="d-flex flex-column">
        <div class="mb-2 d-flex flex-column gap-3">

          <mat-form-field subscriptSizing="dynamic" class="">
            <mat-label>Estado</mat-label>
            <mat-select formControlName="EstadoFilterControl">
              <mat-option value="">- Todos -</mat-option>
              <mat-option value="Rechazado">Rechazado</mat-option>
              <mat-option value="En Proceso">En Proceso</mat-option>
              <mat-option value="Vendido">Vendido</mat-option>
              <mat-option value="No aplica">No aplica</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field subscriptSizing="dynamic" class="">
            <mat-label>Poblacion</mat-label>
            <input formControlName="PoblacionFilterControl" matInput>
          </mat-form-field>

          <mat-form-field subscriptSizing="dynamic" class="">
            <mat-label>Provincia</mat-label>
            <input formControlName="ProvinciaFilterControl" matInput>
          </mat-form-field>

          <mat-form-field subscriptSizing="dynamic" class="">
            <mat-label>Producto</mat-label>
            <input formControlName="ProductoFilterControl" matInput>
          </mat-form-field>

          <mat-form-field subscriptSizing="dynamic" class="">
            <mat-label>Familia</mat-label>
            <input formControlName="FamiliaFilterControl" matInput>
          </mat-form-field>

          <mat-form-field subscriptSizing="dynamic" class="">
            <mat-label>Subfamilia</mat-label>
            <input formControlName="SubFamiliaFilterControl" matInput>
          </mat-form-field>
        </div>
        <div class="content-end gap-2 d-flex mt-2">
          <button class="buttons-rechazos text-white" mat-button>Filtrar</button>
          <button (click)="filtroReset()" class="buttons-rechazos text-white" mat-button>Limpiar</button>
          <button (click)="drawer.toggle()" class="buttons-rechazos text-white" mat-button>Cancelar</button>
        </div>
      </div>
    </form>
  </mat-drawer>
</mat-drawer-container>