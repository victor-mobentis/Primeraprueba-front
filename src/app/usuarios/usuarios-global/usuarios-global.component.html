<div class="usuarios-container">
  <h1>Gestión de Usuarios</h1>

  <div class="loading-spinner" *ngIf="loading">
    <mat-spinner></mat-spinner>
  </div>

  <div class="table-container" *ngIf="!loading">
    <table mat-table [dataSource]="usuarios" class="usuarios-table">
      
      <!-- Columna Nombre -->
      <ng-container matColumnDef="name">
        <th mat-header-cell *matHeaderCellDef>Nombre</th>
        <td mat-cell *matCellDef="let usuario">{{ usuario.name }}</td>
      </ng-container>

      <!-- Columna Email -->
      <ng-container matColumnDef="email">
        <th mat-header-cell *matHeaderCellDef>Email</th>
        <td mat-cell *matCellDef="let usuario">{{ usuario.email }}</td>
      </ng-container>

      <!-- Columna Cargo -->
      <ng-container matColumnDef="position_company">
        <th mat-header-cell *matHeaderCellDef>Cargo</th>
        <td mat-cell *matCellDef="let usuario">{{ usuario.position_company || 'N/A' }}</td>
      </ng-container>

      <!-- Columna Roles -->
      <ng-container matColumnDef="roles">
        <th mat-header-cell *matHeaderCellDef>Roles</th>
        <td mat-cell *matCellDef="let usuario">
          <div class="roles-container">
            <mat-chip-set>
              <mat-chip 
                *ngFor="let role of allRoles"
                (click)="toggleRole(usuario, role.id)"
                [disabled]="!canAssignRoles"
                [ngClass]="{'chip-selected': hasRole(usuario, role.id)}"
                class="role-chip"
                [matTooltip]="role.description">
                {{ role.name }}
              </mat-chip>
            </mat-chip-set>
          </div>
        </td>
      </ng-container>

      <!-- Columna Permisos -->
      <ng-container matColumnDef="permissions">
        <th mat-header-cell *matHeaderCellDef>Permisos</th>
        <td mat-cell *matCellDef="let usuario">
          <div class="permissions-container">
            <mat-form-field appearance="outline" class="permissions-select">
              <mat-label>Seleccionar permisos</mat-label>
              <mat-select 
                multiple
                [value]="getSelectedPermissions(usuario)"
                (selectionChange)="onPermissionsChange(usuario, $event.value)"
                [disabled]="!canAssignPermissions">
                <mat-option 
                  *ngFor="let permission of allPermissions" 
                  [value]="permission.id"
                  [disabled]="isPermissionFromRole(usuario, permission.id)">
                  <div class="permission-option">
                    <span [class.permission-from-role]="isPermissionFromRole(usuario, permission.id)">
                      {{ permission.description }}
                      <mat-icon 
                        *ngIf="isPermissionFromRole(usuario, permission.id)" 
                        class="role-indicator"
                        matTooltip="Heredado del rol">
                        security
                      </mat-icon>
                    </span>
                  </div>
                </mat-option>
              </mat-select>
              <mat-hint *ngIf="canAssignPermissions">Los permisos con candado vienen del rol</mat-hint>
            </mat-form-field>
          </div>
        </td>
      </ng-container>

      <!-- Columna Acciones -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef class="actions-header">Acciones</th>
        <td mat-cell *matCellDef="let usuario" class="actions-cell">
          <button 
            mat-icon-button 
            class="delete-btn"
            [disabled]="!isAdmin || usuario.deleted"
            (click)="deleteUser(usuario)"
            [matTooltip]="usuario.deleted ? 'Usuario ya eliminado' : 'Eliminar usuario'">
            <mat-icon>{{ usuario.deleted ? 'delete_forever' : 'delete' }}</mat-icon>
          </button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
    </table>
  </div>

  <div class="info-panel" *ngIf="!loading && usuarios.length > 0">
    <mat-card>
      <mat-card-header>
        <mat-card-title>Información</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <p><strong>Total de usuarios:</strong> {{ usuarios.length }}</p>
        <p *ngIf="canAssignRoles"><mat-icon>info</mat-icon> Puedes asignar/quitar roles haciendo clic en ellos.</p>
        <p *ngIf="canAssignPermissions"><mat-icon>info</mat-icon> Usa el selector para asignar permisos. Los permisos con candado <mat-icon class="inline-icon">security</mat-icon> vienen del rol y no se pueden desmarcar</p>
        <p *ngIf="!canAssignRoles && !canAssignPermissions"><mat-icon>warning</mat-icon> No tienes permisos para modificar roles o permisos</p>
      </mat-card-content>
    </mat-card>
  </div>
</div>
