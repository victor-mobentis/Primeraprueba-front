<div class="screen">
  <div class="separador-superior"></div>
  <div class="">
    <div class="d-flex justify-content-between m-4">
      <h1 class="mb-0">
        <img class="icon-title" src="assets/images/iconos/clientes-icon-dark.svg" alt="Clientes" matListItemIcon />
        <span class=" mb-0 ps-2 color-dark page-heading">Clientes</span>
      </h1>
    </div>


    <div class="m-3">
      <div class="d-flex align-items-center justify-content-between gap-5 mb-3">
        <!-- buscador -->
        <div class="d-flex gap-3 align-items-center">
          <div class="input-group" id="busqueda">
            <input class="form-control border-end-0 border" type="search" placeholder="Buscar..."
              id="example-search-input">
            <span class="input-group-append">
              <button class="btn btn-outline-secondary bg-white border-start-0 border-bottom-0 border ms-n5"
                type="button">
                <i class="fa fa-search"></i>
              </button>
            </span>
          </div>
          <!-- boton de filtos aplicados o limpiar -->
          <div class="d-flex gap-2 align-items-center">
              <button class="d-flex m-0 btn btn-outline-danger btn-sm align-items-center" *ngFor="let filtro of filtrosAplicados" (click)="removeFilter(filtro)">
                <p class="m-0">{{ filtro.nombre }}: {{ filtro.valor }}</p>
                <i class="ps-2 bi bi-x-circle-fill"></i>
              </button>
        
            <!-- Botón "Limpiar" solo si hay filtros aplicados -->
            <button *ngIf="filtrosAplicados.length > 0" class="btn btn-outline-danger btn-sm" (click)="filtroReset()">
              Limpiar
            </button>
          </div>
          <!-- filtros --> 
          <div   class="btn-group" #dropdownWrapper>
            <a type="button" class=" dropdown-toggle fw-semibold text-decoration-none color-text" data-bs-toggle="dropdown" aria-expanded="false" data-bs-auto-close="outside" id="dropdownMenuButton">
              + Filtros
            </a>
            <ul class="dropdown-menu cursor">
              <form [formGroup]="form" (ngSubmit)="applyComplexFilter()">
                <!-- Segmentacion 1 Potenciabilidad -->
                <li class="dropend">
                  <a class="dropdown-item dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" data-bs-auto-close="outside">Potenciabilidad</a>
                  <ul class="dropdown-menu">
                    <li *ngFor="let item of s1" class="cursor">
                      <a class="dropdown-item" [ngClass]="{'selected-item': form.get('segmentacion1FilterControl')?.value?.includes(item.segmentation_value_id)}"  (click)="onFilterSelect(item.segmentation_value_id, 1)">
                        {{ item.segmentation_value }}
                      </a>
                    </li>
                  </ul>
                </li>
                <!-- Segementacion 2 Tipologia -->
                <li class="dropend">
                  <a class="dropdown-item dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" data-bs-auto-close="outside">Tipologia</a>
                  <ul class="dropdown-menu">
                    <li *ngFor="let item of s2" class="cursor">
                      <a class="dropdown-item" [ngClass]="{'selected-item': form.get('segmentacion2FilterControl')?.value?.includes(item.segmentation_value_id)}"  (click)="onFilterSelect(item.segmentation_value_id, 2)">
                        {{ item.segmentation_value }}
                      </a>
                    </li>
                  </ul>
                </li>
                <!-- Segementacion 3 Imagen -->
                <li class="dropend">
                  <a class="dropdown-item dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" data-bs-auto-close="outside">Imagen</a>
                  <ul class="dropdown-menu">
                    <li *ngFor="let item of s3" class="cursor">
                      <a class="dropdown-item" [ngClass]="{'selected-item': form.get('segmentacion3FilterControl')?.value?.includes(item.segmentation_value_id)}"  (click)="onFilterSelect(item.segmentation_value_id, 3)">
                        {{ item.segmentation_value }}
                      </a>
                    </li>
                  </ul>
                </li>
                <!-- Cliente -->
                <li class="dropend">
                  <a class="dropdown-item dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" data-bs-auto-close="outside">Cliente</a>
                  <ul class="dropdown-menu p-2">
                      <input type="text" class="form-control" formControlName="cliente" placeholder="Introduzca el nombre del cliente">
                  </ul>
                </li>
                <!-- Provincia -->
                <li class="dropend">
                  <a class="dropdown-item dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" data-bs-auto-close="outside">Provincia</a>
                  <ul class="dropdown-menu">
                    <li *ngFor="let item of provinciaList" class="cursor" >
                      <a 
                        class="dropdown-item"
                        (click)="onFilterLocationSelect('Provincia', item)"
                      >
                        {{item}}
                      </a>
                    </li>
                  </ul>
                </li>
                <!-- Población -->
                <li class="dropend">
                  <a class="dropdown-item dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" data-bs-auto-close="outside">Población</a>
                  <ul class="dropdown-menu poblacion">
                    <li *ngFor="let item of poblacionList" class="cursor">
                      <a class="dropdown-item" (click)="onFilterLocationSelect('Población', item)">
                        {{item}}
                      </a>
                    </li>
                  </ul>
                </li>
              </form>
            </ul>
          </div>
        </div>

        <!-- botones de  filtros y mapa -->
        <div class="boton-filtro d-flex gap-2 align-self-start me-3">
          <button ngbTooltip="Ver en Mapa" class="btn btn-color d-flex justify-content-center align-items-center gap-2"
            (click)="verEnMapa()">
            <mat-icon>location_on</mat-icon>
          </button>
<!--           <button ngbTooltip="Ver filtros" class="btn btn-secondary d-flex align-items-center" data-bs-toggle="modal"
            data-bs-target="#filtroModal">
            <mat-icon class="p-0 m-0">filter_list_alt</mat-icon>
          </button> -->
        </div>

      </div>
      <!-- tabla -->
      <div class="table-responsive {{cargando?'d-none':''}}">
        <table class="table table-hover table-sm">
          <!-- Checkbox Column -->
          <thead>
            <tr>
              <th class="th-checkbox row_column_checkbox text-center px-2">
                <div class="d-flex align-items-center">
                  <input type="checkbox" (change)="masterToggle()" [checked]="selection.hasValue() && isAllSelected()"
                    [indeterminate]="selection.hasValue() && !isAllSelected()">
                </div>
              </th>
              <th scope="col" class="row_column_sm cursor" (click)="sortData('customer_ERP_id')">
                Código
                <i *ngIf="sortColumn === 'customer_ERP_id'" class="bi" [ngClass]="sortDirection === 'asc' ? 'bi-arrow-up' : 'bi-arrow-down'"></i>
              </th>
              <th scope="col" class="cursor row_column_lg" (click)="sortData('name')">
                Nombre
                <i *ngIf="sortColumn === 'name'" class="bi" [ngClass]="sortDirection === 'asc' ? 'bi-arrow-up' : 'bi-arrow-down'"></i>
              </th>
              <th scope="col" class="row_column_md cursor" (click)="sortData('province')">
                Provincia
                <i *ngIf="sortColumn === 'province'" class="bi" [ngClass]="sortDirection === 'asc' ? 'bi-arrow-up' : 'bi-arrow-down'"></i>
              </th>
              <th scope="col" class="row_column_md cursor" (click)="sortData('city')">
                Población
                <i *ngIf="sortColumn === 'city'" class="bi" [ngClass]="sortDirection === 'asc' ? 'bi-arrow-up' : 'bi-arrow-down'"></i>
              </th>
              <th scope="col" class="row_column_sm cursor" (click)="sortData('pc')">
                C.P.
                <i *ngIf="sortColumn === 'pc'" class="bi" [ngClass]="sortDirection === 'asc' ? 'bi-arrow-up' : 'bi-arrow-down'"></i>
              </th>
              <th scope="col" class="cursor row_column_xl" (click)="sortData('address')">
                Dirección
                <i *ngIf="sortColumn === 'address'" class="bi" [ngClass]="sortDirection === 'asc' ? 'bi-arrow-up' : 'bi-arrow-down'"></i>
              </th>
              <th scope="col" class="text-center row_column_sm">Ficha</th>
            </tr>
          </thead>
          <tbody>
            <ng-container *ngFor="let row of paginatedData">
              <tr>
                <td class="text-center px-2">
                  <div class="d-flex align-items-center">
                    <input type="checkbox" (click)="$event.stopPropagation()" (change)="selection.toggle(row)"
                      [checked]="selection.isSelected(row)" [disabled]="isCheckboxDisabled(row)">
                  </div>
                </td>
                <td>{{ row.customer_ERP_id }}</td>
                <td [title]="row.name">
                  {{ row.name }}
                </td>
                <td [title]="row.province">
                  {{ row.province }}
                </td>
                <td [title]="row.city">
                  {{ row.city }}
                </td>
                <td>{{ row.pc != 0 ? row.pc : "" }}</td>
                <td [title]="row.address">
                  {{ row.address }}
                </td>
                <td class="text-center">
                  <button class="btn btn-link p-0" (click)="editClient(row.id)" title="Ficha">
                    <i class="bi bi-eye-fill fs-5 icon_color cursor"></i>
                  </button>
                </td>
              </tr>

            </ng-container>
          </tbody>
        </table>

      </div>
      <div class="d-flex justify-content-center {{cargando?'':'d-none'}}">
        <div class="spinner-border" role="status">
          <span class="sr-only">Loading...</span>
        </div>
      </div>

      <!-- Componente de paginación externo -->
      <app-pagination [totalItems]="dataSource.data.length" [itemsPerPage]="itemsPerPage" [currentPage]="currentPage"
        (pageChange)="onPageChange($event)" (itemsPerPageChanged)="onItemsPerPageChanged($event)">
      </app-pagination>


      
    </div>
  </div>

  <!-- apartado de filtros -->
  <!-- <div class="modal fade" tabindex="-1" id="filtroModal" aria-labelledby="filtroModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-slide-right">
      <div class="modal-content">
        <div class="bg-blanco sticky">
          <div class="modal-header d-flex align-items-center gap-2 mb-2">
            <img src="../../../assets/images/iconos/filtros-icon.svg" alt="" width="32" height="32" alt="filtro"
              class="icono-svg">
            <h2 class="my-0">Filtro de clientes</h2>
          </div>
          <div class="modal-body">
            <form [formGroup]="form" (ngSubmit)="applyComplexFilter()" class="d-flex flex-column gap-3">
              <div class="d-flex flex-column gap-3">
                <div class="col-12 justify-content-end gap-2 d-flex mt-2">
                  <button class="btn btn-color" type="submit" (click)="applyComplexFilter()">Filtrar</button>
                  <button type="button" class="btn btn-secondary" (click)="filtroReset()">Limpiar</button>
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"
                    aria-label="Close">Cancelar</button>
                </div>
                <div class="mb-2 d-flex flex-column gap-3">
                  <div class="mb-2">
                    <label for="start">Periodo de ventas</label>
                    <div class="input-group">
                      <input type="date" class="form-control" formControlName="start" id="start" placeholder="Desde">
                      <input type="date" class="form-control" formControlName="end" id="end" placeholder="Hasta">
                    </div>
                  </div>
                  <div *ngIf="s1.length > 0" class="mb-2">
                    <label>{{s1[0].name}}</label>
                    <ng-select [items]="s1" bindLabel="segmentation_value" bindValue="segmentation_value_id"
                      formControlName="segmentacion1FilterControl" [multiple]="true" class="form-control p-0"
                      placeholder="Seleccione una o más opciones">
                    </ng-select>
                  </div>
                  <div *ngIf="s2.length > 0" class="mb-2">
                    <label>{{s2[0].name}}</label>
                    <ng-select [items]="s2" bindLabel="segmentation_value" bindValue="segmentation_value_id"
                      formControlName="segmentacion2FilterControl" [multiple]="true" class="form-control p-0"
                      placeholder="Seleccione una o más opciones">
                    </ng-select>
                  </div>

                  <div *ngIf="s3.length > 0" class="mb-2">
                    <label>{{s3[0].name}}</label>
                    <ng-select [items]="s3" bindLabel="segmentation_value" bindValue="segmentation_value_id"
                      formControlName="segmentacion3FilterControl" [multiple]="true" class="form-control p-0"
                      placeholder="Seleccione una o más opciones">
                    </ng-select>
                  </div>

                  <div class="mb-2">
                    <label for="cliente">Cliente</label>
                    <input type="text" class="form-control" formControlName="cliente"
                      placeholder="Introduzca el nombre del cliente">
                  </div>

                  <div class="mb-2">
                    <label for="provincia">Provincia</label>
                    <ng-select [items]="provinciaList" bindLabel="name" [multiple]="true"
                      formControlName="provinciaFilterControl" class="form-control p-0"
                      placeholder="Seleccione una o más provincias">
                    </ng-select>
                  </div>

                  <div class="mb-2">
                    <label for="poblacion">Población</label>
                    <ng-select [items]="poblacionList" bindLabel="name" [multiple]="true"
                      formControlName="poblacionFilterControl" class="form-control p-0"
                      placeholder="Seleccione una o más poblaciones">
                    </ng-select>
                  </div>

                  <div class="mb-2">
                    <label for="agente">Vendedor</label>
                    <ng-select [items]="agenteList" bindLabel="name" bindValue="id" [multiple]="true"
                      formControlName="agenteFilterControl" class="form-control p-0"
                      placeholder="Seleccione uno o más vendedores">
                    </ng-select>
                  </div>

                  <div class="mb-2">
                    <label for="familia">Familia</label>
                    <ng-select [items]="familiaList" bindLabel="name" [multiple]="true"
                      formControlName="familiaFilterControl" class="form-control p-0"
                      placeholder="Seleccione una o más familias">
                    </ng-select>
                  </div>
                </div>
              </div>
            </form>

          </div>
        </div>
      </div>
    </div>
  </div> -->
</div>